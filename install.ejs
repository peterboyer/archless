#!/bin/env bash

set -e

<% if (clock_ntp === true) { %>
  timedatectl set-ntp true
<% } %>

<% if (typeof keyboard_mapfile === "string") { %>
  loadkeys <%- keyboard_mapfile %>
<% } %>

<% if (partition_scheme !== undefined) { %>
  <% if (partition_swap === true) { %>
    SWAPGB="1"
  <% } else if (typeof partition_swap === "number" && partition_swap > 0) { %>
    SWAPGB="<%= partition_swap %>"
  <% } else if (partition_swap === "memory") { %>
    SWAPGB="$(free --giga | grep Mem | awk '{ print $2 }')"
  <% } %>
  <% if (partition_scheme) { %>
    <% if (partition_scheme === "auto") { %>
      set +e
      ls /sys/firmware/efi/efivars &> /dev/null
      if [[ $? -eq 0 ]]; then
        PARTITIONSCHEME=g
      else
        PARTITIONSCHEME=M
      fi
      set -e
    <% } else if (partition_scheme === "gpt") { %>
      PARTITIONSCHEME=g
    <% } else if (partition_scheme === "mbr") { %>
      PARTITIONSCHEME=M
    <% } %>
    (
      echo $PARTITIONSCHEME;
      echo n; echo; echo; echo +300M;
      <% if (partition_swap) { %>
        echo n; echo; echo; echo "+$(expr $SWAPGB)G";
      <% } %>
      echo n; echo; echo; echo;
      echo w;
    ) | fdisk $dev &>/dev/null
  <% } %>
<% } %>
